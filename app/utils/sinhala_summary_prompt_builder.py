from typing import Optional
 
 
def _get_summary_rules(grade_level: str) -> dict:
    """
    Internal helper: maps grade_level enum to linguistic constraints
    """
 
    if grade_level == "6 - 8":
        return {
            "audience": "lower_secondary",
            "instruction": (
                "‡∂â‡∂≠‡∑è ‡∑É‡∂ª‡∂Ω ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. "
                "‡∂ö‡∑ô‡∂ß‡∑í ‡∑Ä‡∑è‡∂ö‡∑ä‚Äç‡∂∫ ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. "
                "‡∂Ø‡∑ê‡∂©‡∑í ‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂±‡∑í‡∂ö ‡∂¥‡∂Ø ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂±‡∑ú‡∂ö‡∂ª‡∂±‡∑ä‡∂±."
            ),
            "max_sentences": 5,
        }
 
    if grade_level == "9 - 11":
        return {
            "audience": "upper_secondary",
            "instruction": (
                "‡∑É‡∂ª‡∂Ω ‡∂±‡∂∏‡∑î‡∂≠‡∑ä ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. "
                "‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂Ö‡∂Ø‡∑Ñ‡∑É‡∑ä ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í ‡∂ö‡∂ª‡∂±‡∑ä‡∂±."
            ),
            "max_sentences": 7,
        }
 
    if grade_level == "12 - 13":
        return {
            "audience": "advanced_secondary",
            "instruction": (
                "‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. "
                "‡∂Ö‡∂Ø‡∑Ñ‡∑É‡∑ä ‡∂Ö‡∂≠‡∂ª ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞‡∂≠‡∑è ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í ‡∂ö‡∂ª‡∂±‡∑ä‡∂±."
            ),
            "max_sentences": 10,
        }
 
    if grade_level == "university":
        return {
            "audience": "academic",
            "instruction": (
                "‡∂ã‡∑É‡∑É‡∑ä ‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∂∫‡∂± ‡∂∏‡∂ß‡∑ä‡∂ß‡∂∏‡∑ö ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. "
                "‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑Ä‡∑è‡∂ö‡∑ä‚Äç‡∂∫ ‡∑É‡∑Ñ ‡∑É‡∂Ç‡∂ö‡∂Ω‡∑ä‡∂¥ ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±."
            ),
            "max_sentences": 12,
        }
 
    # safe fallback
    return {
        "audience": "default",
        "instruction": "‡∑É‡∂∏‡∑ä‡∂∏‡∂≠ ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫‡∂ö‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±.",
        "max_sentences": 7,
    }
 
 
def build_summary_prompt(
    context: str,
    grade_level: str,
    query: Optional[str] = None,
) -> str:
    """
    Builds a grade-adaptive, zero-hallucination Sinhala summary prompt
    """
 
    rules = _get_summary_rules(grade_level)
    query_part = f"‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±‡∂∫ / ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏: {query}\n\n" if query else ""
 
    return f"""
‡∂î‡∂∂‡∂ß ‡∂¥‡∑Ñ‡∂≠ **‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∂∫‡∂± ‡∂Ö‡∂±‡∑ä‡∂≠‡∂ª‡∑ä‡∂ú‡∂≠‡∂∫** ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ì ‡∂á‡∂≠.
‡∂∏‡∑ô‡∂∏ ‡∂Ö‡∂±‡∑ä‡∂≠‡∂ª‡∑ä‡∂ú‡∂≠‡∂∫ ‡∂∏‡∂≠ ‡∂¥‡∂Ø‡∂±‡∂∏‡∑ä‡∑Ä ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫‡∂ö‡∑ä ‡∑É‡∑è‡∂Ø‡∂±‡∑ä‡∂±.
 
üéì ‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö ‡∂¥‡∑è‡∂®‡∂ö‡∂∫‡∑è: {rules['audience']}
üìè ‡∂ã‡∂¥‡∂ª‡∑í‡∂∏ ‡∑Ä‡∑è‡∂ö‡∑ä‚Äç‡∂∫ ‡∂ú‡∂´‡∂±: {rules['max_sentences']}
 
üß† ‡∂∑‡∑è‡∑Ç‡∑è ‡∂±‡∑í‡∂∫‡∂∏:
{rules['instruction']}
 
üîí ZERO HALLUCINATION ‡∂±‡∑í‡∂∫‡∂∏:
‚Ä¢ ‡∂Ö‡∂±‡∑ä‡∂≠‡∂ª‡∑ä‡∂ú‡∂≠‡∂∫‡∑ö ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠‡∑í ‡∂ö‡∂ª‡∑î‡∂´‡∑î ‡∂ë‡∂ö‡∂≠‡∑î ‡∂±‡∑ú‡∂ö‡∂ª‡∂±‡∑ä‡∂±
‚Ä¢ ‡∂±‡∑Ä ‡∂ã‡∂Ø‡∑è‡∑Ñ‡∂ª‡∂´ ‡∑Ñ‡∑ù ‡∂Ö‡∂Ø‡∑Ñ‡∑É‡∑ä ‡∑É‡∑ë‡∂Ø‡∑ì‡∂∏‡∑ô‡∂±‡∑ä ‡∑Ä‡∑Ö‡∂ö‡∑í‡∂±‡∑ä‡∂±
 
{query_part}üìö ‡∂Ö‡∂±‡∑ä‡∂≠‡∂ª‡∑ä‡∂ú‡∂≠‡∂∫:
{context}
 
‚úçÔ∏è ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫:
"""